<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FlowReporter Command Center</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        #sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1001;
        }
        .sidebar-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
            text-align: center;
        }
        .sidebar-header h2 { margin: 0; font-size: 1.5rem; }
        .stats { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
        
        #report-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* Report Item Card */
        .report-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid #ccc; /* Default border color */
        }
        .report-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: #f1f3f5;
        }
        .report-cat { font-weight: bold; font-size: 1.1rem; color: #333; }
        .report-meta { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .badge {
            display: inline-block; padding: 3px 8px; border-radius: 12px; 
            font-size: 0.75rem; font-weight: bold; color: white;
        }

        /* Map Styles */
        #map { flex: 1; height: 100%; }
        
        /* Popup Image */
        .popup-img { width: 100%; height: auto; border-radius: 4px; margin-top: 8px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2>ðŸ’§ FlowReporter</h2>
            <div class="stats" id="stats-text">Loading reports...</div>
            <form action="{% url 'logout' %}" method="post" style="margin-top: 10px;">
                {% csrf_token %}
                <button type="submit" style="
                    width: 100%;
                    padding: 8px; 
                    background: #e74c3c; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer;
                    font-size: 0.9rem;">
                    Log Out
                </button>
            </form>
        </div>
        <div id="report-list">
            </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 1. Initialize Map
        var map = L.map('map').setView([-1.2921, 36.8219], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // 2. Define Custom Icons
        var icons = {
            red: new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            orange: new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            green: new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            })
        };

        // Helper: Choose color based on Severity
        function getIcon(severity) {
            if (!severity) return icons.green;
            var s = severity.toLowerCase();
            if (s === 'critical' || s === 'high') return icons.red;
            if (s === 'medium') return icons.orange;
            return icons.green; // Low or New
        }

        // Helper: Get border color for list cards
        function getBorderColor(severity) {
            var s = severity ? severity.toLowerCase() : '';
            if (s === 'critical' || s === 'high') return '#e74c3c'; // Red
            if (s === 'medium') return '#f39c12'; // Orange
            return '#2ecc71'; // Green
        }

        // 3. Fetch Data
        fetch('/api/reports/submit/')
            .then(res => res.json())
            .then(data => {
                // Update Stats
                document.getElementById('stats-text').innerText = `${data.length} Active Reports`;
                
                // Get list container
                var listContainer = document.getElementById('report-list');
                
                // Reverse data to show newest first
                data.reverse().forEach(report => {
                    // --- A. MAP MARKER ---
                    if (report.latitude && report.longitude) {
                        var marker = L.marker([report.latitude, report.longitude], {
                            icon: getIcon(report.severity)
                        }).addTo(map);

                        // Popup Content
                        var popupHTML = `
                            <b>${report.category}</b><br>
                            Severity: <b style="color:${getBorderColor(report.severity)}">${report.severity}</b><br>
                            Status: ${report.status}
                        `;
                        if (report.image_file) {
                            popupHTML += `<br><img src="${report.image_file}" class="popup-img">`;
                        }
                        marker.bindPopup(popupHTML);

                        // --- B. SIDEBAR LIST ITEM ---
                        var item = document.createElement('div');
                        item.className = 'report-item';
                        item.style.borderLeftColor = getBorderColor(report.severity);
                        item.innerHTML = `
                            <div class="report-cat">${report.category}</div>
                            <div class="report-meta">
                                <span class="badge" style="background:${getBorderColor(report.severity)}">${report.severity}</span>
                                &nbsp; Status: ${report.status}
                            </div>
                        `;
                        
                        // Click Event: Fly to marker
                        item.addEventListener('click', () => {
                            map.flyTo([report.latitude, report.longitude], 16);
                            marker.openPopup();
                        });

                        listContainer.appendChild(item);
                    }
                });
            })
            .catch(err => console.error("Error:", err));
    </script>
</body>
</html>